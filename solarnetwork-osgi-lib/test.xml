<project basedir="." xmlns:ivy="antlib:org.apache.ivy.ant" xmlns:if="ant:if">

	<property file="${basedir}/build.properties"/>
	<property name="dir.test.reports" value="${basedir}/reports"/>
	
	<import file="lib-build.xml"/>

	<macrodef name="bundle-iterate">
		<attribute name="target"/>
		<sequential>
			<subant target="@{target}">
				<fileset refid="test.build.files"/>
				<property name="dir.test.reports" value="${dir.test.reports}"/>
			</subant>
		</sequential>
	</macrodef>
	
	<target name="test-all.clean">
		<delete dir="${dir.test.reports}" failonerror="no"/>
	</target>
	
	<target name="test-all-clean" description="Clean and build all unit tests report from scratch"
		depends="test-all.clean,test-all"/>

	<target name="test-all" description="Build all unit tests report from scratch">
		<fileset id="test.build.files" dir="${basedir}/../..">
			<include name="solarnetwork-common/*.test/build.xml"/>
			<include name="solarnetwork-external/*.test/build.xml"/>
			<include name="solarnetwork-node/*.test/build.xml"/>
			<include name="solarnetwork-central/*.test/build.xml"/>
		</fileset>
		<pathconvert property="test.build.bundles" pathsep="${line.separator}&#9;">
			<fileset refid="test.build.files"/>
			<mapper type="regexp" from="^.*/(solarnetwork-.*)/build.xml$$" to="\1"/>
		</pathconvert>
		<echo message="Projects to test:${line.separator}&#9;${test.build.bundles}"/>
		<bundle-iterate target="clean-test"/>
		<antcall target="test-report"/>
	</target>

</project>
